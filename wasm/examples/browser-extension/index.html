<!DOCTYPE html>
<html>
    <head>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <link rel="stylesheet" href="./resources/style.css">
        <script type="module">
            // import { log, stringify, currentNetwork } from './resources/utils.js';

            // import * as kaspa from '../../web/kaspa/kaspa.js';
            // let { Resolver, RpcClient, Encoding, kaspaToSompi } = kaspa;

            (async () => {
                //await kaspa.default('../../web/kaspa/kaspa_bg.wasm');

                // let networkId = currentNetwork();
                // log(`Connecting to Kaspa network...`);
                // log(`Selected network is ${networkId}...`);
                
                // const rpc = new RpcClient({
                //     resolver : new Resolver(),
                //     networkId,
                // });

                // await rpc.connect();
                // log("Connected to", rpc.url);
                
                // log("GetBlockDagInfo request...");
                // const info = await rpc.getBlockDagInfo();
                // log("GetBlockDagInfo response:", info);

                // log("Disconnected...");
                // await rpc.disconnect();

                const $ = q=>document.querySelector(q);
               

                let connect = $("#connect");
                connect.addEventListener("click", async (e) => {
                    e.preventDefault();
                    
                    let list = $("#wallets");
                    let temp = $("#wallet-tpl");
                    
                    let wallets = discover_kaspa_wallet();
                    wallets.forEach(w=>{
                        //console.log("wallet", w)
                        let wallet = temp.content.cloneNode(true);
                        wallet.querySelector(".title").innerHTML = w.name;
                        wallet.querySelector(".icon").src = w.icon;
                        wallet.querySelector(".wallet").dataset.uuid = w.uuid;
                        list.appendChild(wallet);
                    })

                    if (wallets.length){
                        connect.disabled = true
                    }
                    
                });

                let wallets = $("#wallets");
                let connectedWallet = null;
                wallets.addEventListener("click", async (e) => {
                    e.preventDefault();
                    let uuid = e.target.closest(".wallet").dataset.uuid;
                    let wallets = discover_kaspa_wallet();
                    let wallet = wallets.find(w=>w.uuid == uuid)
                    console.log("wallet", uuid, wallet)
                    if (!wallet?.api)
                        return

                    let result = await wallet.api.connect();
                    console.log("wallet.api.connect result", result)
                    if (result.address){
                        $("#wallet-id").value = result.address
                        $("#wallet-id").parentNode.classList.add("show");
                        $(".form-request").classList.add("show");
                        connectedWallet = wallet;
                    }
                });

                $("#request").addEventListener("click", async(e)=>{
                    e.preventDefault();
                    $("#request-loading-spinner").classList.add("show");
                    let address = $("#receive-address").value;
                    let amount = $("#amount").value;
                    console.log("address", address);
                    console.log("amount", amount);
                    
                    function requestPaymentProxy(){
                        return new Promise((resolve)=>{
                            setTimeout(()=>{
                                resolve({txId:"0ca72bbef3cfb28ba5d082ff083481aea7ab89cb85af75c25ab095db66a48752"})
                            }, 1000);
                        })
                    }
                    //let result = await connectedWallet.api.requestPayment({address, amount});
                    let result = await requestPaymentProxy({address, amount});

                    $("#request-loading-spinner").classList.remove("show");
                    if (result.txId){
                        $("#tx-id").innerHTML = result.txId;
                        $("#tx-id").href = "https://explorer.kaspa.org/txs/"+result.txId;
                        $("#tx-id").parentNode.classList.add("show");
                    }
                });

            })();

        </script>
    </head>
    <body class="align-items-center p-4 bg-body-tertiary_">
        <div class="w-50 m-auto mb-4">
            <h1><%=user_greeting_msg%></h1>
            <button id="connect" class="btn btn-primary">Connect wallet</button>
            <div id="wallets"></div>
            <div class="form-floating collapse">
                <input class="form-control" id="wallet-id" disabled>
                <label for="wallet-id">Wallet connected</label>
            </div>
        </div>
        <div class="form-request w-50 m-auto collapse">
            <form class="position-relative">
                <h1 class="h3 mb-3 fw-normal">Request payment</h1>
                <div class="form-floating mb-3">
                    <input class="form-control" id="receive-address" disabled value="<%=address%>">
                    <label for="receive-address">Receive Address</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="number" class="form-control" id="amount" placeholder="1.0">
                    <label for="amount">Payment amount</label>
                </div>
                <button class="btn btn-primary w-100 py-2" id="request">Request</button>
                <div id="request-loading-spinner" class="collapse">
                    <div class="bg-success bg-opacity-50 d-flex align-items-center w-100 h-100 top-0 z-3 position-absolute p-5 rounded-3">
                        <div class="m-auto spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="my-3 collapse">
                    <label for="tx-id">Transaction ID: </label>
                    <a href="" id="tx-id" target="_blank" disabled></a>
                </div>
            </form>
        </div>
        <template id="wallet-tpl">
            <div class="wallet btn btn-light">
                <img class="icon" width="50" height="50">
                <h2 class="title"></h2>
            </div>
          </template>
    </body>
</html>