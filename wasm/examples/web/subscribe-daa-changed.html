<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="./resources/style.css">
        <script type="module">
            import { log, stringify, currentNetwork, disconnectAction } from './resources/utils.js';

            // import WASM32 SDK
            import * as kaspa from '../../web/kaspa-rpc/kaspa.js';
            let { Resolver, RpcClient, Encoding } = kaspa;

            (async () => {
                // load WASM32 SDK binaries 
                await kaspa.default('../../web/kaspa-rpc/kaspa_bg.wasm');

                // let url = beacon.getUrl(Encoding.Borsh, "mainnet")
                // get network from URL hash
                
                try {
                    
                    let network = currentNetwork();
                    log(`Connecting to Kaspa network...`);
                    log(`Selected network is ${network.class("network")}...`);
                    
                    const resolver = new Resolver();
                    const rpc = await resolver.connect(network);
                    // const rpc = new RpcClient({ url, networkId: "mainnet" });
                    
                    log("Connected to", rpc.url.class("network"));
                    log("Registering for DAA notifications...");
                    
                    let el = document.createElement("code");
                    
                    await rpc.registerListener(async (op, payload) => {
                        el.innerHTML = `${op} ${stringify(payload)}`;
                    });
                    
                    log("Subscribing to DAA score...");
                    rpc.subscribeDaaScore();
                    log("Receiving notifications...\n");
                    
                    document.body.appendChild(el);

                    disconnectAction(rpc);

                } catch (e) {
                    log("Error:", e);
                }
                
            })();
        </script>
    </head>
    <body></body>
</html>